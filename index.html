<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Finance Tracker</title>
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí∞</text></svg>">
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN (no longer needed, but kept for now as it's a CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom styles for the app */
        body {
            font-family: "Inter", sans-serif;
            background-color: #f0f2f5; /* Light mode background */
            color: #1a202c; /* Light mode default text */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top for better content flow */
            min-height: 100vh;
            padding: 20px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .container {
            background-color: #ffffff; /* Light mode container background */
            border-radius: 1rem; /* Rounded corners for the main container */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 900px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .nav-button {
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            text-align: center;
        }
        .nav-button.active {
            background-color: #3b82f6; /* Blue-500 */
            color: #ffffff;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.4);
        }
        .nav-button:not(.active) {
            background-color: #e5e7eb; /* Gray-200 */
            color: #4b5563; /* Gray-700 */
        }
        .nav-button:not(.active):hover {
            background-color: #d1d5db; /* Gray-300 */
        }
        .card {
            background-color: #f9fafb; /* Light mode card background */
            border-radius: 0.75rem;
            padding: 1.25rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .input-field {
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db; /* Gray-300 */
            width: 100%;
            transition: border-color 0.2s ease-in-out, background-color 0.3s ease, color 0.3s ease;
        }
        .input-field:focus {
            outline: none;
            border-color: #3b82f6; /* Blue-500 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .btn-primary {
            background-color: #22c55e; /* Green-500 */
            color: #ffffff;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
        }
        .btn-primary:hover {
            background-color: #16a34a; /* Green-600 */
        }
        .btn-secondary {
            background-color: #ef4444; /* Red-500 */
            color: #ffffff;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
        }
        .btn-secondary:hover {
            background-color: #dc2626; /* Red-600 */
        }
        .btn-tertiary {
            background-color: #6b7280; /* Gray-500 */
            color: #ffffff;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
        }
        .btn-tertiary:hover {
            background-color: #4b5563; /* Gray-700 */
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #ffffff; /* Light mode modal background */
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 400px;
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out, background-color 0.3s ease, color 0.3s ease;
            position: relative; /* Needed for absolute positioning of close button */
        }
        .modal.show .modal-content {
            transform: translateY(0);
        }
        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e5e7eb; /* Light mode border */
            transition: border-color 0.3s ease;
        }
        .transaction-item:last-child {
            border-bottom: none;
        }
        .transaction-income {
            color: #10b981; /* Green-500 */
            font-weight: 600;
        }
        .transaction-expense {
            color: #ef4444; /* Red-500 */
            font-weight: 600;
        }
        .transaction-payment {
            color: #3b82f6; /* Blue-500 */
            font-weight: 600;
        }
        .settings-icon {
            font-size: 1.5rem; /* Adjust size as needed */
            cursor: pointer;
            color: #4b5563; /* Gray-700 */
            transition: color 0.2s ease-in-out;
        }
        .settings-icon:hover {
            color: #3b82f6; /* Blue-500 */
        }
        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            line-height: 1;
            color: #6b7280; /* Gray-500 */
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            transition: color 0.2s ease-in-out;
        }
        .modal-close-btn:hover {
            color: #ef4444; /* Red-500 */
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text for dark mode */
        }
        .dark-mode .container {
            background-color: #2d3748; /* Darker container background */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
        .dark-mode .nav-button:not(.active) {
            background-color: #4a5568; /* Darker gray for inactive nav buttons */
            color: #e2e8f0;
        }
        .dark-mode .nav-button:not(.active):hover {
            background-color: #6b7280; /* Even darker gray on hover */
        }
        .dark-mode .card {
            background-color: #4a5568; /* Darker card background */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        .dark-mode .input-field {
            background-color: #2d3748; /* Dark input background */
            border-color: #6b7280; /* Darker border */
            color: #e2e8f0; /* Light text in inputs */
        }
        .dark-mode .input-field::placeholder { /* Placeholder text color */
            color: #a0aec0;
        }
        .dark-mode .modal-content {
            background-color: #2d3748; /* Darker modal background */
            color: #e2e8f0;
        }
        .dark-mode .transaction-item {
            border-bottom-color: #4a5568; /* Darker border for transactions */
        }
        .dark-mode .text-gray-700 { /* Adjusting specific gray text for dark mode */
            color: #cbd5e0;
        }
        .dark-mode .text-gray-800 { /* Adjusting specific gray text for dark mode */
            color: #f7fafc;
        }
        .dark-mode .text-gray-500 { /* Adjusting specific gray text for dark mode */
            color: #a0aec0;
        }

        /* Toggle Switch Styling */
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #3b82f6; /* Blue-500 */
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #3b82f6;
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(16px);
            -ms-transform: translateX(16px);
            transform: translateX(16px);
        }

        /* Progress bar styles */
        .progress-bar-container {
            width: 100%;
            background-color: #e5e7eb; /* Light mode Gray-200 */
            border-radius: 0.5rem;
            height: 1.25rem; /* h-5 */
            overflow: hidden;
            position: relative; /* Added for absolute positioning of text */
            display: flex; /* Added for centering the bar within the container */
            align-items: center; /* Added for vertical centering of the bar */
        }
        .progress-bar-fill {
            height: 100%;
            width: 0%; /* Initial width */
            border-radius: 0.5rem;
            transition: width 0.5s ease-in-out, background-color 0.3s ease;
        }
        .progress-bar-green { background-color: #10b981; } /* Green-500 */
        .progress-bar-yellow { background-color: #f59e0b; } /* Yellow-500 */
        .progress-bar-red { background-color: #ef4444; } /* Red-500 */

        /* Dark mode for progress bar */
        .dark-mode .progress-bar-container {
            background-color: #6b7280; /* Changed to a lighter gray for visibility in dark mode */
        }

        /* Text overlay for progress bars */
        .progress-text-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.75rem; /* text-xs */
            color: #4b5563; /* Default text color for light mode (gray-700) */
            transition: color 0.3s ease;
        }
        .dark-mode .progress-text-overlay {
            color: #cbd5e0; /* Default text color for dark mode (gray-300/400) */
        }

        /* Delete button styling */
        .delete-btn { /* Generic class for both transaction and card delete buttons */
            min-width: 30px; /* Ensure button doesn't shrink too much */
            text-align: center;
            /* Adjusted padding and added flex properties for better alignment */
            padding: 0; /* Remove default padding */
            width: 28px; /* Fixed width for a square button */
            height: 28px; /* Fixed height for a square button */
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.375rem; /* Match btn-tertiary */
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
            background-color: #ef4444; /* Red-500 */
            color: #ffffff;
            font-size: 0.875rem; /* Slightly larger font for better visibility, text-sm */
            line-height: 1; /* Ensure text is vertically centered */
        }
        .delete-btn:hover {
            background-color: #dc2626; /* Red-600 */
        }
        .delete-btn.confirm-state {
            background-color: #f59e0b; /* Yellow-500 for confirm state */
            color: white;
        }
        /* Message box styles for copy/import feedback */
        .message-box {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .message-box.show {
            opacity: 1;
        }

        /* Mobile Navigation Specific Styles */
        .mobile-nav-toggle {
            display: block; /* Always show on mobile */
            font-size: 2rem; /* Large hamburger icon */
            background: none;
            border: none;
            color: #4b5563; /* Gray-700 */
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease;
        }
        .mobile-nav-toggle:hover {
            background-color: #e5e7eb;
        }
        .dark-mode .mobile-nav-toggle {
            color: #e2e8f0;
        }
        .dark-mode .mobile-nav-toggle:hover {
            background-color: #4a5568;
        }

        .main-nav-buttons {
            display: none; /* Hidden by default on mobile */
            flex-direction: column; /* Stack vertically on mobile */
            position: absolute;
            top: 100%; /* Position below the header */
            left: 0;
            width: 100%;
            background-color: #ffffff; /* White background for dropdown */
            border-radius: 0.5rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            gap: 0.5rem;
            z-index: 999; /* Ensure it's above other content but below modals */
        }
        .main-nav-buttons.show-mobile-menu {
            display: flex; /* Show when toggled */
        }
        .dark-mode .main-nav-buttons {
            background-color: #2d3748; /* Darker background for dropdown */
        }

        /* Desktop Navigation */
        @media (min-width: 768px) { /* md breakpoint */
            .mobile-nav-toggle {
                display: none; /* Hide hamburger on desktop */
            }
            .main-nav-buttons {
                display: flex; /* Show horizontal nav on desktop */
                flex-direction: row;
                position: static; /* Reset positioning */
                background-color: transparent; /* No background for desktop nav */
                box-shadow: none;
                padding: 0;
                gap: 1rem; /* Adjust spacing */
            }
            .nav-container {
                justify-content: center; /* Center nav items on desktop */
            }
        }
    </style>
</head>
<body class="bg-gray-100 p-4">
    <div class="container mx-auto">
        <!-- Login/Registration Section -->
        <section id="authSection" class="section-content">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Welcome to Finance Tracker</h2>

            <div class="card mb-6">
                <h3 class="text-2xl font-semibold text-gray-800 mb-4">Login</h3>
                <form id="loginForm" class="grid grid-cols-1 gap-4">
                    <div>
                        <label for="loginUsername" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                        <input type="text" id="loginUsername" class="input-field" required>
                    </div>
                    <div>
                        <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="loginPassword" class="input-field" required>
                    </div>
                    <div>
                        <button type="submit" class="btn-primary w-full">Login</button>
                    </div>
                </form>
                <p class="text-center text-gray-600 mt-4">Don't have an account? <a href="#" id="showRegister" class="text-blue-600 hover:underline">Register here</a></p>
            </div>

            <div class="card hidden" id="registerCard">
                <h3 class="text-2xl font-semibold text-gray-800 mb-4">Register</h3>
                <form id="registerForm" class="grid grid-cols-1 gap-4">
                    <div>
                        <label for="registerUsername" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                        <input type="text" id="registerUsername" class="input-field" required>
                    </div>
                    <div>
                        <label for="registerPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="registerPassword" class="input-field" required>
                    </div>
                    <div>
                        <button type="submit" class="btn-primary w-full">Register</button>
                    </div>
                </form>
                <p class="text-center text-gray-600 mt-4">Already have an account? <a href="#" id="showLogin" class="text-blue-600 hover:underline">Login here</a></p>
            </div>
        </section>

        <!-- Main App Sections (Initially Hidden) -->
        <div id="mainAppContent" class="hidden">
            <!-- Navigation -->
            <nav class="flex justify-between items-center mb-6 relative nav-container">
                <!-- Hamburger menu for mobile -->
                <button id="mobileNavToggle" class="mobile-nav-toggle md:hidden">‚ò∞</button>

                <!-- Main navigation buttons (hidden on mobile by default) -->
                <div id="mainNavButtons" class="main-nav-buttons hidden md:flex">
                    <button id="navDashboard" class="nav-button active">Dashboard</button>
                    <button id="navTransactions" class="nav-button">Transactions</button>
                    <button id="navCreditCards" class="nav-button">Credit Cards</button>
                </div>
                <!-- Settings Icon -->
                <span id="settingsBtn" class="settings-icon ml-auto md:ml-0">‚öôÔ∏è</span>
                <button id="logoutBtn" class="btn-secondary ml-4 px-4 py-2 rounded-md font-semibold">Logout</button>
            </nav>

            <!-- Dashboard Section -->
            <section id="dashboardSection" class="section-content hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Your Financial Overview</h2>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="card text-center">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Total Cash</h3>
                        <p id="totalCash" class="text-4xl font-extrabold text-green-600">$0.00</p>
                    </div>
                    <div class="card text-center">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Total Credit Card Debt</h3>
                        <p id="totalCreditCardDebt" class="text-4xl font-extrabold text-red-600">$0.00</p>
                    </div>
                    <div class="card text-center">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Safe to Spend</h3>
                        <p id="safeToSpend" class="text-4xl font-extrabold text-blue-600">$0.00</p>
                    </div>
                </div>

                <!-- Add Transaction Form -->
                <div class="card">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-4">Add New Transaction</h3>
                    <form id="transactionForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="transactionType" class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                            <select id="transactionType" class="input-field" required>
                                <option value="income">Income</option>
                                <option value="expense">Expense</option>
                            </select>
                        </div>
                        <div>
                            <label for="transactionAmount" class="block text-sm font-medium text-gray-700 mb-1">Amount ($)</label>
                            <input type="number" id="transactionAmount" class="input-field" step="0.01" min="0.01" required>
                        </div>
                        <div class="md:col-span-2">
                            <label for="transactionDescription" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                            <input type="text" id="transactionDescription" class="input-field" placeholder="e.g., Salary, Groceries" required>
                        </div>
                        <div class="md:col-span-2">
                            <button type="submit" class="btn-primary w-full">Add Transaction</button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Transaction History Section -->
            <section id="transactionsSection" class="section-content hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Transaction History</h2>
                <div class="card">
                    <ul id="transactionList" class="divide-y divide-gray-200">
                        <!-- Transactions will be dynamically loaded here -->
                        <li class="py-3 text-center text-gray-500">No transactions yet.</li>
                    </ul>
                </div>
            </section>

            <!-- Credit Cards Section -->
            <section id="creditCardsSection" class="section-content hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Manage Credit Cards</h2>

                <!-- Add Credit Card Form -->
                <div class="card mb-6">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-4">Add New Credit Card</h3>
                    <form id="addCreditCardForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="cardName" class="block text-sm font-medium text-gray-700 mb-1">Card Name</label>
                            <input type="text" id="cardName" class="input-field" placeholder="e.g., Visa Rewards" required>
                        </div>
                        <div>
                            <label for="creditLimit" class="block text-sm font-medium text-gray-700 mb-1">Credit Limit ($)</label>
                            <input type="number" id="creditLimit" class="input-field" step="0.01" min="0.01" required>
                        </div>
                        <div class="md:col-span-2">
                            <button type="submit" class="btn-primary w-full">Add Credit Card</button>
                        </div>
                    </form>
                </div>

                <!-- Overall Credit Utilization -->
                <div class="card mb-6">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-4">Overall Credit Utilization</h3>
                    <div class="mb-2 flex justify-between items-baseline">
                        <!-- This span will now contain the percentage and emoji -->
                        <span id="overallUtilizationText" class="text-2xl font-bold text-gray-800 dark:text-gray-200">0.00%</span>
                        <span class="text-sm text-gray-500">Recommended Use Under 30%</span>
                    </div>
                    <div class="progress-bar-container">
                        <div id="overallUtilizationBar" class="progress-bar-fill"></div>
                        <!-- The text is now outside the bar, but inside the container -->
                        <span id="overallUtilizationOverlay" class="progress-text-overlay"></span>
                    </div>
                </div>

                <!-- Credit Card List -->
                <div class="card">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-4">Your Credit Cards</h3>
                    <div id="creditCardList" class="grid grid-cols-1 gap-4">
                        <!-- Credit cards will be dynamically loaded here -->
                        <p class="text-center text-gray-500 py-4">No credit cards added yet.</p>
                    </div>
                </div>
            </section>
        </div> <!-- End of mainAppContent -->

        <!-- Modals for Credit Card Actions -->

        <!-- Pay Credit Card Modal -->
        <div id="payCreditCardModal" class="modal">
            <div class="modal-content">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Pay Credit Card</h3>
                <p class="text-gray-700 mb-4">Paying towards: <span id="payCardName" class="font-bold"></span></p>
                <form id="payCreditCardForm">
                    <label for="payAmount" class="block text-sm font-medium text-gray-700 mb-1">Amount to Pay ($)</label>
                    <input type="number" id="payAmount" class="input-field mb-4" step="0.01" min="0.01" required>
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancelPay" class="btn-tertiary">Cancel</button>
                        <button type="submit" class="btn-primary">Pay</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Charge Credit Card Modal -->
        <div id="chargeCreditCardModal" class="modal">
            <div class="modal-content">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Charge Credit Card</h3>
                <p class="text-gray-700 mb-4">Charging: <span id="chargeCardName" class="font-bold"></span></p>
                <form id="chargeCreditCardForm">
                    <label for="chargeAmount" class="block text-sm font-medium text-gray-700 mb-1">Amount to Charge ($)</label>
                    <input type="number" id="chargeAmount" class="input-field mb-4" step="0.01" min="0.01" required>
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancelCharge" class="btn-tertiary">Cancel</button>
                        <button type="submit" class="btn-secondary">Charge</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settingsModal" class="modal">
            <div class="modal-content">
                <button class="modal-close-btn" id="closeSettingsModal">&times;</button>
                <div id="settingsContentInitial">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Settings</h3>
                    <div class="flex flex-col gap-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700">Dark Mode</span>
                            <label class="switch">
                                <input type="checkbox" id="darkModeToggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <button id="saveDataSeedBtn" class="btn-primary w-full">Save Data Seed</button>
                        <button id="importDataBtn" class="btn-primary w-full">Import Data</button>
                        <button id="resetDataBtn" class="btn-secondary w-full">Reset All Data</button>
                    </div>
                </div>

                <!-- Save Data Seed Menu (hidden by default) -->
                <div id="saveDataSeedMenu" class="hidden">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Save Data Seed</h3>
                    <textarea id="dataSeedOutput" class="input-field mb-4 h-32 resize-none" readonly></textarea>
                    <div class="flex flex-col gap-3">
                        <button id="downloadDataSeedBtn" class="btn-primary w-full">Download Data Seed</button>
                        <button id="copyDataSeedToClipboardBtn" class="btn-primary w-full">Copy Data Seed to Clipboard</button>
                        <button id="closeSaveDataSeedMenuBtn" class="btn-tertiary w-full">Close</button>
                    </div>
                </div>

                <!-- Import Data Menu (hidden by default) -->
                <div id="importDataMenu" class="hidden">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Import Data</h3>
                    <div class="flex flex-col gap-3">
                        <button id="importFromFileBtn" class="btn-primary w-full">Import from File</button>
                        <input type="file" id="fileInput" accept=".txt" class="hidden">
                        <button id="importFromClipboardBtn" class="btn-primary w-full">Import from Clipboard</button>
                        <button id="closeImportDataMenuBtn" class="btn-tertiary w-full">Close</button>
                    </div>
                </div>

                <!-- Import from Clipboard Section (hidden by default) -->
                <div id="importFromClipboardSection" class="hidden">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Import from Clipboard</h3>
                    <textarea id="dataSeedInput" class="input-field mb-4 h-32 resize-none" placeholder="Paste your data seed here..."></textarea>
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancelClipboardImportBtn" class="btn-tertiary">Cancel</button>
                        <button type="button" id="submitClipboardImportBtn" class="btn-primary">Import</button>
                    </div>
                </div>

                <!-- Confirm Import Modal (hidden by default) -->
                <div id="confirmImportModal" class="hidden">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Confirm Data Import</h3>
                    <p class="text-gray-700 mb-6 text-center">Are you sure you want to import this data? This will overwrite all your current financial records.</p>
                    <div class="flex justify-center space-x-3">
                        <button type="button" id="cancelConfirmImportBtn" class="btn-tertiary">No, Cancel</button>
                        <button type="button" id="confirmImportActionBtn" class="btn-secondary">Yes, Import</button>
                    </div>
                </div>

                <!-- Reset Data Confirmation (original) -->
                <div id="settingsContentConfirm" class="hidden">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Confirm Reset</h3>
                    <p class="text-gray-700 mb-6 text-center">Are you sure you want to reset all data? This action cannot be undone.</p>
                    <div class="flex justify-center space-x-3">
                        <button type="button" id="cancelResetBtn" class="btn-tertiary">No, Cancel</button>
                        <button type="button" id="confirmResetBtn" class="btn-secondary">Yes, Reset</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Message Box for feedback -->
        <div id="messageBox" class="message-box"></div>

    </div>

    <script>
        // Global variables to store financial data
        let cash = 0;
        let transactions = [];
        let creditCards = [];
        let isDarkMode = false; // New variable for dark mode state
        const deleteTimers = new Map(); // Stores timeout IDs for transaction delete buttons
        const deleteCardTimers = new Map(); // Stores timeout IDs for credit card delete buttons

        // Backend API URL
        const API_BASE_URL = 'http://localhost:5000'; // Make sure this matches your Flask backend URL

        // Authentication token
        let authToken = localStorage.getItem('authToken'); // Load token from localStorage initially

        // DOM Elements
        const totalCashEl = document.getElementById('totalCash');
        const totalCreditCardDebtEl = document.getElementById('totalCreditCardDebt');
        const safeToSpendEl = document.getElementById('safeToSpend');
        const transactionForm = document.getElementById('transactionForm');
        const transactionListEl = document.getElementById('transactionList');
        const addCreditCardForm = document.getElementById('addCreditCardForm');
        const creditCardListEl = document.getElementById('creditCardList');
        const overallUtilizationTextEl = document.getElementById('overallUtilizationText');
        const overallUtilizationBarEl = document.getElementById('overallUtilizationBar');
        const overallUtilizationOverlayEl = document.getElementById('overallUtilizationOverlay');

        // Navigation buttons and sections
        const navDashboard = document.getElementById('navDashboard');
        const navTransactions = document.getElementById('navTransactions');
        const navCreditCards = document.getElementById('navCreditCards');
        const mobileNavToggle = document.getElementById('mobileNavToggle');
        const mainNavButtons = document.getElementById('mainNavButtons');

        const dashboardSection = document.getElementById('dashboardSection');
        const transactionsSection = document.getElementById('transactionsSection');
        const creditCardsSection = document.getElementById('creditCardsSection');

        // Auth Section elements
        const authSection = document.getElementById('authSection');
        const mainAppContent = document.getElementById('mainAppContent');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const showRegisterBtn = document.getElementById('showRegister');
        const showLoginBtn = document.getElementById('showLogin');
        const registerCard = document.getElementById('registerCard');
        const logoutBtn = document.getElementById('logoutBtn');


        // Modals and their elements
        const payCreditCardModal = document.getElementById('payCreditCardModal');
        const payCardNameEl = document.getElementById('payCardName');
        const payCreditCardForm = document.getElementById('payCreditCardForm');
        const payAmountInput = document.getElementById('payAmount');
        const cancelPayBtn = document.getElementById('cancelPay');

        const chargeCreditCardModal = document.getElementById('chargeCreditCardModal');
        const chargeCardNameEl = document.getElementById('chargeCardName');
        const chargeCreditCardForm = document.getElementById('chargeCreditCardForm');
        const chargeAmountInput = document.getElementById('chargeAmount');
        const cancelChargeBtn = document.getElementById('cancelCharge');

        // Settings Modal elements
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const settingsContentInitial = document.getElementById('settingsContentInitial');
        const settingsContentConfirm = document.getElementById('settingsContentConfirm');
        const resetDataBtn = document.getElementById('resetDataBtn');
        const confirmResetBtn = document.getElementById('confirmResetBtn');
        const cancelResetBtn = document.getElementById('cancelResetBtn');
        const closeSettingsModalBtn = document.getElementById('closeSettingsModal');
        const darkModeToggle = document.getElementById('darkModeToggle'); // New dark mode toggle

        // Seed/Import elements
        const saveDataSeedBtn = document.getElementById('saveDataSeedBtn'); // New button
        const importDataBtn = document.getElementById('importDataBtn');
        const saveDataSeedMenu = document.getElementById('saveDataSeedMenu'); // New menu
        const dataSeedOutput = document.getElementById('dataSeedOutput');
        const downloadDataSeedBtn = document.getElementById('downloadDataSeedBtn'); // New button
        const copyDataSeedToClipboardBtn = document.getElementById('copyDataSeedToClipboardBtn'); // New button
        const closeSaveDataSeedMenuBtn = document.getElementById('closeSaveDataSeedMenuBtn'); // New button
        const importDataMenu = document.getElementById('importDataMenu'); // New menu
        const importFromFileBtn = document.getElementById('importFromFileBtn'); // New button
        const fileInput = document.getElementById('fileInput'); // New hidden input
        const importFromClipboardBtn = document.getElementById('importFromClipboardBtn'); // New button
        const closeImportDataMenuBtn = document.getElementById('closeImportDataMenuBtn'); // New button
        const importFromClipboardSection = document.getElementById('importFromClipboardSection'); // Renamed/repurposed
        const dataSeedInput = document.getElementById('dataSeedInput');
        const cancelClipboardImportBtn = document.getElementById('cancelClipboardImportBtn');
        const submitClipboardImportBtn = document.getElementById('submitClipboardImportBtn');
        const confirmImportModal = document.getElementById('confirmImportModal');
        const cancelConfirmImportBtn = document.getElementById('cancelConfirmImportBtn');
        const confirmImportActionBtn = document.getElementById('confirmImportActionBtn');
        const messageBox = document.getElementById('messageBox');

        let currentCardIdForModal = null; // To store the ID of the card being acted upon
        let importedDataToConfirm = null; // To hold data during import confirmation

        // Interval for auto-saving
        let autoSaveIntervalId = null;
        const AUTO_SAVE_INTERVAL = 30 * 1000; // 30 seconds

        /**
         * Displays a temporary message box with the given text.
         * @param {string} message - The message to display.
         * @param {number} duration - Duration in milliseconds for the message to show.
         */
        function showMessageBox(message, duration = 3000) {
            messageBox.textContent = message;
            messageBox.classList.add('show');
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, duration);
        }

        /**
         * Formats a number into a compact currency string (e.g., $1.23M, $500.00).
         * @param {number} num - The number to format.
         * @returns {string} The formatted currency string.
         */
        function formatCurrency(num) {
            // Check if num is negative, store sign, and work with absolute value
            const isNegative = num < 0;
            num = Math.abs(num);

            if (num >= 1_000_000_000_000) { // Trillions
                return `${isNegative ? '-' : ''}${(num / 1_000_000_000_000).toFixed(2)}T`;
            } else if (num >= 1_000_000_000) { // Billions
                return `${isNegative ? '-' : ''}${(num / 1_000_000_000).toFixed(2)}B`;
            } else if (num >= 1_000_000) { // Millions
                return `${isNegative ? '-' : ''}${(num / 1_000_000).toFixed(2)}M`;
            } else {
                // For numbers less than a million, format as standard currency
                return `${isNegative ? '-' : ''}$${num.toFixed(2)}`;
            }
        }


        /**
         * Shows the specified section and hides others. Updates active navigation button.
         * @param {string} sectionName - The name of the section to show ('dashboard', 'transactions', 'creditCards').
         */
        function showSection(sectionName) {
            // Hide all sections
            dashboardSection.classList.add('hidden');
            transactionsSection.classList.add('hidden');
            creditCardsSection.classList.add('hidden');

            // Remove active class from all nav buttons
            navDashboard.classList.remove('active');
            navTransactions.classList.remove('active');
            navCreditCards.classList.remove('active');

            // Show the selected section and add active class to its button
            switch (sectionName) {
                case 'dashboard':
                    dashboardSection.classList.remove('hidden');
                    navDashboard.classList.add('active');
                    break;
                case 'transactions':
                    transactionsSection.classList.remove('hidden');
                    navTransactions.classList.add('active');
                    renderTransactions(); // Re-render transactions when section is shown
                    break;
                case 'creditCards':
                    creditCardsSection.classList.remove('hidden');
                    navCreditCards.classList.add('active');
                    renderCreditCards(); // Re-render credit cards when section is shown
                    updateOverallUtilization(); // Update overall utilization when credit cards section is shown
                    break;
            }
            // Close mobile menu after selection
            mainNavButtons.classList.remove('show-mobile-menu');
        }

        /**
         * Toggles between light and dark mode.
         */
        function toggleDarkMode() {
            isDarkMode = darkModeToggle.checked;
            localStorage.setItem('darkMode', isDarkMode); // Save preference
            applyTheme(); // Apply the new theme
        }

        /**
         * Applies the current theme (light or dark) to the body.
         */
        function applyTheme() {
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
            darkModeToggle.checked = isDarkMode; // Ensure toggle reflects current state
        }

        /**
         * Loads financial data and dark mode preference from localStorage.
         * This function is now only for initial dark mode loading.
         * Actual financial data loading will be from the backend.
         */
        function loadLocalData() {
            try {
                const storedDarkMode = localStorage.getItem('darkMode'); // Load dark mode preference
                isDarkMode = storedDarkMode === 'true'; // Convert string to boolean
            } catch (e) {
                console.error("Error loading data from localStorage:", e);
                isDarkMode = false; // Default to light mode on error
            }
        }

        /**
         * Saves current financial data to localStorage.
         * This function is now only for dark mode preference.
         * Actual financial data saving will be to the backend.
         */
        function saveLocalData() {
            try {
                localStorage.setItem('darkMode', isDarkMode); // Save dark mode preference
            }
            catch (e) {
                console.error("Error saving data to localStorage:", e);
            }
        }

        /**
         * Updates the dashboard display (Total Cash, Total Credit Card Debt, Safe to Spend).
         */
        function updateDashboard() {
            let totalCreditCardDebt = creditCards.reduce((sum, card) => sum + card.balance, 0);
            let safeToSpend = cash - totalCreditCardDebt;

            totalCashEl.textContent = formatCurrency(cash);
            totalCreditCardDebtEl.textContent = formatCurrency(totalCreditCardDebt);
            safeToSpendEl.textContent = formatCurrency(safeToSpend);

            // Apply color based on safeToSpend value
            if (safeToSpend >= 0) {
                safeToSpendEl.classList.remove('text-red-600');
                safeToSpendEl.classList.add('text-blue-600');
            } else {
                safeToSpendEl.classList.remove('text-blue-600');
                safeToSpendEl.classList.add('text-red-600');
            }

            // Trigger backend save after any data change
            if (authToken) {
                saveDataToBackend();
            }
        }

        /**
         * Handles the submission of the add transaction form.
         * @param {Event} event - The form submission event.
         */
        function handleAddTransaction(event) {
            event.preventDefault();

            const type = document.getElementById('transactionType').value;
            const amount = parseFloat(document.getElementById('transactionAmount').value);
            const description = document.getElementById('transactionDescription').value.trim();

            if (isNaN(amount) || amount <= 0) {
                showMessageBox('Please enter a valid positive amount.');
                return;
            }
            if (!description) {
                showMessageBox('Please enter a description.');
                return;
            }

            addTransaction(type, amount, description);

            // Clear the form
            transactionForm.reset();
        }

        /**
         * Adds a new transaction to the history and updates cash balance.
         * @param {string} type - 'income' or 'expense'.
         * @param {number} amount - The transaction amount.
         * @param {string} description - Description of the transaction.
         * @param {string} [cardId=null] - Optional: ID of the credit card involved (for payments/charges).
         */
        function addTransaction(type, amount, description, cardId = null) {
            const newTransaction = {
                id: Date.now(), // Unique ID for the transaction
                type: type,
                amount: amount,
                description: description,
                date: new Date().toISOString(), // ISO string for consistent date storage
                cardId: cardId // Link to credit card if applicable
            };
            transactions.unshift(newTransaction); // Add to the beginning for chronological display

            if (type === 'income') {
                cash += amount;
            } else if (type === 'expense' && cardId === null) { // Only subtract cash for direct expenses (not credit card charges)
                cash -= amount;
            }
            // If it's a credit card charge (type 'expense' and cardId is not null), cash is NOT affected here.

            updateDashboard();
            renderTransactions(); // Re-render transaction list
        }

        /**
         * Renders the list of transactions in the transaction history section.
         */
        function renderTransactions() {
            transactionListEl.innerHTML = ''; // Clear existing list

            if (transactions.length === 0) {
                transactionListEl.innerHTML = '<li class="py-3 text-center text-gray-500">No transactions yet.</li>';
                return;
            }

            transactions.forEach(t => {
                const listItem = document.createElement('li');
                listItem.classList.add('transaction-item');

                const date = new Date(t.date).toLocaleDateString(undefined, {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                const time = new Date(t.date).toLocaleTimeString(undefined, {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                let amountDisplay = '';
                let amountClass = '';

                if (t.type === 'income') {
                    amountClass = 'transaction-income';
                    amountDisplay = `+ ${formatCurrency(t.amount)}`;
                } else if (t.type === 'expense' && t.description.startsWith('Credit Card Payment')) {
                    // Specific handling for credit card payments
                    amountClass = 'transaction-payment'; // Neutral color
                    amountDisplay = `Paid off ${formatCurrency(t.amount)}`;
                } else {
                    amountClass = 'transaction-expense';
                    amountDisplay = `- ${formatCurrency(t.amount)}`;
                }

                listItem.innerHTML = `
                    <div>
                        <p class="font-medium text-gray-800">${t.description}</p>
                        <p class="text-sm text-gray-500">${date} ${time}</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <p class="${amountClass}">${amountDisplay}</p>
                        <button class="delete-btn delete-transaction-btn" data-transaction-id="${t.id}" data-state="delete">X</button>
                    </div>
                `;
                transactionListEl.appendChild(listItem);
            });

            // Add event listeners for delete buttons
            document.querySelectorAll('.delete-transaction-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const buttonEl = e.target;
                    const transactionId = parseInt(buttonEl.dataset.transactionId);
                    const currentState = buttonEl.dataset.state;

                    if (currentState === 'delete') {
                        // Change to confirm state
                        buttonEl.textContent = 'Confirm';
                        buttonEl.classList.add('confirm-state');
                        buttonEl.dataset.state = 'confirm';

                        // Clear any existing timer for this button
                        if (deleteTimers.has(transactionId)) {
                            clearTimeout(deleteTimers.get(transactionId));
                        }

                        // Set a new timer to revert after 5 seconds
                        const timerId = setTimeout(() => {
                            buttonEl.textContent = 'X';
                            buttonEl.classList.remove('confirm-state');
                            buttonEl.dataset.state = 'delete';
                            deleteTimers.delete(transactionId); // Remove timer from map
                        }, 5000); // 5 seconds

                        deleteTimers.set(transactionId, timerId); // Store timer ID
                    } else if (currentState === 'confirm') {
                        // Confirm deletion
                        if (deleteTimers.has(transactionId)) {
                            clearTimeout(deleteTimers.get(transactionId)); // Clear the timer
                            deleteTimers.delete(transactionId); // Remove timer from map
                        }
                        handleDeleteTransaction(transactionId);
                    }
                });
            });
        }

        /**
         * Handles the deletion of a transaction and reverses its financial impact.
         * @param {number} transactionId - The ID of the transaction to delete.
         */
        function handleDeleteTransaction(transactionId) {
            const transactionIndex = transactions.findIndex(t => t.id === transactionId);

            if (transactionIndex > -1) {
                const transaction = transactions[transactionIndex];

                // Reverse the financial impact
                if (transaction.type === 'income') {
                    cash -= transaction.amount; // Deduct income
                } else if (transaction.type === 'expense') {
                    if (transaction.cardId) {
                        // This was a credit card related expense (charge or payment)
                        if (transaction.description.startsWith('Credit Card Payment')) {
                            // If it was a payment, cash was decreased, so add it back
                            cash += transaction.amount;
                            // And the card balance was decreased, so add it back
                            const card = creditCards.find(c => c.id === transaction.cardId);
                            if (card) card.balance += transaction.amount;
                        } else { // It was a credit card charge
                            // Cash was NOT decreased by addTransaction for charges (after fix), so don't add it back here.
                            // Only the card balance was increased, so decrease it.
                            const card = creditCards.find(c => c.id === transaction.cardId);
                            if (card) card.balance -= transaction.amount;
                        }
                    } else { // It was a direct cash expense
                        cash += transaction.amount; // Add back expense
                    }
                }

                // Remove the transaction from the array
                transactions.splice(transactionIndex, 1);

                // Update UI
                updateDashboard();
                renderTransactions();
                renderCreditCards(); // Re-render credit cards to reflect balance changes
                updateOverallUtilization(); // Update overall utilization
            } else {
                console.error("Transaction not found for deletion:", transactionId);
            }
        }


        /**
         * Handles the submission of the add credit card form.
         * @param {Event} event - The form submission event.
         */
        function handleAddCreditCard(event) {
            event.preventDefault();

            const cardName = document.getElementById('cardName').value.trim();
            const creditLimit = parseFloat(document.getElementById('creditLimit').value);

            if (!cardName) {
                showMessageBox('Please enter a card name.');
                return;
            }
            if (isNaN(creditLimit) || creditLimit <= 0) {
                showMessageBox('Please enter a valid positive credit limit.');
                return;
            }

            addCreditCard(cardName, creditLimit);

            // Clear the form
            addCreditCardForm.reset();
        }

        /**
         * Adds a new credit card.
         * @param {string} name - Name of the credit card.
         * @param {number} limit - Credit limit of the card.
         */
        function addCreditCard(name, limit) {
            const newCard = {
                id: Date.now(), // Unique ID for the card
                name: name,
                limit: limit,
                balance: 0 // New cards start with 0 balance
            };
            creditCards.push(newCard);
            renderCreditCards(); // Re-render credit card list
            updateDashboard(); // Update dashboard to reflect potential new debt calculation
            updateOverallUtilization(); // Update overall utilization
        }

        /**
         * Renders the list of credit cards in the credit cards section.
         */
        function renderCreditCards() {
            creditCardListEl.innerHTML = ''; // Clear existing list

            if (creditCards.length === 0) {
                creditCardListEl.innerHTML = '<p class="text-center text-gray-500 py-4">No credit cards added yet.</p>';
                // Ensure overall utilization also reflects 0% when no cards
                updateOverallUtilization();
                return;
            }

            creditCards.forEach(card => {
                const utilization = card.limit > 0 ? (card.balance / card.limit * 100).toFixed(2) : 0;
                const barWidth = Math.min(utilization, 100);

                let barColorClass = '';
                let emoji = '';
                if (utilization <= 30) {
                    barColorClass = 'progress-bar-green';
                    emoji = 'üòä'; // Smiling emoji
                } else if (utilization <= 50) {
                    barColorClass = 'progress-bar-yellow';
                    emoji = 'üòê'; // Neutral face emoji
                } else {
                    barColorClass = 'progress-bar-red';
                    emoji = 'üò≠'; // Sobbing emoji
                }

                const cardDiv = document.createElement('div');
                cardDiv.classList.add('card', 'flex', 'flex-col', 'md:flex-row', 'justify-between', 'items-center', 'gap-4');
                cardDiv.innerHTML = `
                    <div class="flex-grow text-center md:text-left w-full">
                        <h4 class="text-xl font-semibold text-gray-800">${card.name}</h4>
                        <p class="text-gray-700">Balance: <span class="font-bold">${formatCurrency(card.balance)}</span></p>
                        <p class="text-gray-700">Limit: <span class="font-bold">${formatCurrency(card.limit)}</span></p>
                        <div class="mb-2 w-full">
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill ${barColorClass}" style="width: ${barWidth}%;"></div>
                                <span class="progress-text-overlay">
                                    ${utilization}% ${emoji}
                                </span>
                            </div>
                            <span class="text-sm text-gray-500">Recommended Use Under 30%</span> </div>
                    </div>
                    <div class="flex space-x-3 mt-4 md:mt-0">
                        <button class="btn-primary pay-btn" data-card-id="${card.id}" data-card-name="${card.name}">Pay</button>
                        <button class="btn-secondary charge-btn" data-card-id="${card.id}" data-card-name="${card.name}">Charge</button>
                        <button class="delete-btn delete-card-btn" data-card-id="${card.id}" data-state="delete">X</button>
                    </div>
                `;
                creditCardListEl.appendChild(cardDiv);
            });

            // Add event listeners for new Pay/Charge buttons
            document.querySelectorAll('.pay-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    currentCardIdForModal = parseInt(e.target.dataset.cardId);
                    payCardNameEl.textContent = e.target.dataset.cardName;
                    payAmountInput.value = ''; // Clear previous input
                    payCreditCardModal.classList.add('show');
                });
            });

            document.querySelectorAll('.charge-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    currentCardIdForModal = parseInt(e.target.dataset.cardId);
                    chargeCardNameEl.textContent = e.target.dataset.cardName;
                    chargeAmountInput.value = ''; // Clear previous input
                    chargeCreditCardModal.classList.add('show');
                });
            });

            // Add event listeners for new Credit Card Delete buttons
            document.querySelectorAll('.delete-card-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const buttonEl = e.target;
                    const cardId = parseInt(buttonEl.dataset.cardId);
                    const currentState = buttonEl.dataset.state;

                    if (currentState === 'delete') {
                        // Change to confirm state
                        buttonEl.textContent = 'Confirm';
                        buttonEl.classList.add('confirm-state');
                        buttonEl.dataset.state = 'confirm';

                        // Clear any existing timer for this button
                        if (deleteCardTimers.has(cardId)) {
                            clearTimeout(deleteTimers.get(cardId));
                        }

                        // Set a new timer to revert after 5 seconds
                        const timerId = setTimeout(() => {
                            buttonEl.textContent = 'X';
                            buttonEl.classList.remove('confirm-state');
                            buttonEl.dataset.state = 'delete';
                            deleteCardTimers.delete(cardId); // Remove timer from map
                        }, 5000); // 5 seconds

                        deleteCardTimers.set(cardId, timerId); // Store timer ID
                    } else if (currentState === 'confirm') {
                        // Confirm deletion
                        if (deleteCardTimers.has(cardId)) {
                            clearTimeout(deleteTimers.get(cardId)); // Clear the timer
                            deleteTimers.delete(cardId); // Remove timer from map
                        }
                        handleDeleteCreditCard(cardId);
                    }
                });
            });
            updateOverallUtilization(); // Call this here to ensure it updates when cards are rendered
        }

        /**
         * Handles the deletion of a credit card.
         * @param {number} cardId - The ID of the credit card to delete.
         */
        function handleDeleteCreditCard(cardId) {
            const cardIndex = creditCards.findIndex(card => card.id === cardId);

            if (cardIndex > -1) {
                creditCards.splice(cardIndex, 1); // Remove the card

                // Update UI
                updateDashboard();
                renderCreditCards(); // Re-render credit cards list
                updateOverallUtilization(); // Update overall utilization
                showMessageBox('Credit card deleted successfully!');
            } else {
                console.error("Credit card not found for deletion:", cardId);
            }
        }

        /**
         * Updates the overall credit utilization percentage and progress bar.
         */
        function updateOverallUtilization() {
            let totalLimit = creditCards.reduce((sum, card) => sum + card.limit, 0);
            let totalBalance = creditCards.reduce((sum, card) => sum + card.balance, 0);
            let overallUtilization = 0;

            if (totalLimit > 0) {
                overallUtilization = (totalBalance / totalLimit * 100);
            }

            let emoji = '';
            if (overallUtilization <= 30) {
                emoji = 'üòä'; // Smiling emoji
            } else if (overallUtilization <= 50) {
                emoji = 'üòê'; // Neutral face emoji
            } else {
                emoji = 'üò≠'; // Sobbing emoji
            }

            // Update the main percentage text above the bar
            overallUtilizationTextEl.textContent = `${overallUtilization.toFixed(2)}% ${emoji}`;
            // Update the text overlay within the progress bar container
            overallUtilizationOverlayEl.textContent = `${overallUtilization.toFixed(2)}% ${emoji}`;


            // Set progress bar width, clamping at 100%
            let barWidth = Math.min(overallUtilization, 100);
            overallUtilizationBarEl.style.width = `${barWidth}%`;

            // Apply color based on utilization to the fill bar
            overallUtilizationBarEl.className = 'progress-bar-fill'; // Reset classes
            if (overallUtilization <= 30) {
                overallUtilizationBarEl.classList.add('progress-bar-green');
            } else if (overallUtilization <= 50) {
                overallUtilizationBarEl.classList.add('progress-bar-yellow');
            } else {
                overallUtilizationBarEl.classList.add('progress-bar-red');
            }
        }

        /**
         * Handles the submission of the pay credit card form.
         * @param {Event} event - The form submission event.
         */
        function handlePayCreditCard(event) {
            event.preventDefault();

            const amount = parseFloat(payAmountInput.value);

            if (isNaN(amount) || amount <= 0) {
                showMessageBox('Please enter a valid positive amount.');
                return;
            }

            payCreditCard(currentCardIdForModal, amount);
            payCreditCardModal.classList.remove('show'); // Close modal
        }

        /**
         * Processes a credit card payment.
         * @param {number} cardId - The ID of the credit card.
         * @param {number} amount - The amount to pay.
         */
        function payCreditCard(cardId, amount) {
            const card = creditCards.find(c => c.id === cardId);
            if (card) {
                // Ensure balance doesn't go below zero
                card.balance = Math.max(0, card.balance - amount);
                cash -= amount; // Deduct from cash
                addTransaction('expense', amount, `Credit Card Payment for ${card.name}`, cardId);
                updateDashboard();
                renderCreditCards();
                updateOverallUtilization(); // Update overall utilization after payment
            } else {
                console.error("Card not found for payment:", cardId);
            }
        }

        /**
         * Handles the submission of the charge credit card form.
         * @param {Event} event - The form submission event.
         */
        function handleChargeCreditCard(event) {
            event.preventDefault();

            const amount = parseFloat(chargeAmountInput.value);

            if (isNaN(amount) || amount <= 0) {
                showMessageBox('Please enter a valid positive amount.');
                return;
            }

            chargeCreditCard(currentCardIdForModal, amount);
            chargeCreditCardModal.classList.remove('show'); // Close modal
        }

        /**
         * Processes a credit card charge.
         * @param {number} cardId - The ID of the credit card.
         * @param {number} amount - The amount to charge.
         */
        function chargeCreditCard(cardId, amount) {
            const card = creditCards.find(c => c.id === cardId);
            if (card) {
                // Prevent charging beyond limit, but allow if limit is 0 (unlimited)
                if (card.limit > 0 && (card.balance + amount > card.limit)) {
                    showMessageBox(`Charging ${formatCurrency(amount)} would exceed your credit limit of ${formatCurrency(card.limit)} for ${card.name}.`);
                    return;
                }
                card.balance += amount;
                // For credit card charges, we record it as an expense, but it does NOT affect cash directly.
                // The impact on 'safeToSpend' comes from the increase in credit card debt.
                addTransaction('expense', amount, `Credit Card Charge for ${card.name}`, cardId);
                updateDashboard();
                renderCreditCards();
                updateOverallUtilization(); // Update overall utilization after charge
            } else {
                console.error("Card not found for charge:", cardId);
            }
        }

        /**
         * Shows the settings modal and ensures the initial content is displayed.
         */
        function showSettingsModal() {
            settingsModal.classList.add('show');
            settingsContentInitial.classList.remove('hidden');
            settingsContentConfirm.classList.add('hidden'); // Hide reset confirmation
            saveDataSeedMenu.classList.add('hidden'); // Hide save seed menu
            importDataMenu.classList.add('hidden'); // Hide import menu
            importFromClipboardSection.classList.add('hidden'); // Hide import from clipboard section
            confirmImportModal.classList.add('hidden'); // Hide import confirmation
        }

        /**
         * Hides the settings modal and resets its content to initial state.
         */
        function hideSettingsModal() {
            settingsModal.classList.remove('show');
            // Reset content to initial state for next time it's opened
            settingsContentInitial.classList.remove('hidden');
            settingsContentConfirm.classList.add('hidden');
            saveDataSeedMenu.classList.add('hidden');
            importDataMenu.classList.add('hidden');
            importFromClipboardSection.classList.add('hidden');
            confirmImportModal.classList.add('hidden');
        }

        /**
         * Shows the confirmation prompt within the settings modal for data reset.
         */
        function showResetConfirmation() {
            settingsContentInitial.classList.add('hidden');
            saveDataSeedMenu.classList.add('hidden');
            importDataMenu.classList.add('hidden');
            importFromClipboardSection.classList.add('hidden');
            confirmImportModal.classList.add('hidden');
            settingsContentConfirm.classList.remove('hidden');
        }

        /**
         * Clears all stored data (except dark mode preference) and refreshes the application UI.
         * This now only clears local state, the backend data will persist unless user explicitly deletes it.
         */
        function clearAllDataAndRefresh() {
            // Clear in-memory financial data
            cash = 0;
            transactions = [];
            creditCards = [];

            // Update UI based on current (preserved) dark mode
            updateDashboard();
            renderTransactions();
            renderCreditCards();
            updateOverallUtilization(); // Update overall utilization after reset

            hideSettingsModal(); // Close the settings modal
            showSection('dashboard'); // Navigate back to dashboard
            showMessageBox('All local data reset successfully! Server data is unaffected.');
        }

        /**
         * Generates the data seed string.
         * @returns {string} The base64 encoded data seed.
         */
        function generateDataSeedString() {
            const data = {
                cash: cash,
                transactions: transactions,
                creditCards: creditCards
            };
            const jsonString = JSON.stringify(data);
            return btoa(jsonString); // Base64 encode for a "seed" look and safe transfer
        }

        /**
         * Shows the save data seed menu and populates the textarea.
         */
        function showSaveDataSeedMenu() {
            settingsContentInitial.classList.add('hidden');
            importDataMenu.classList.add('hidden');
            importFromClipboardSection.classList.add('hidden');
            settingsContentConfirm.classList.add('hidden');
            confirmImportModal.classList.add('hidden');
            saveDataSeedMenu.classList.remove('hidden');
            dataSeedOutput.value = generateDataSeedString(); // Populate textarea
        }

        /**
         * Downloads the data seed as a .data file.
         */
        function downloadDataSeed() {
            const dataSeed = generateDataSeedString();
            const blob = new Blob([dataSeed], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'FinanceTrackerData.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showMessageBox('Data seed downloaded as .txt file!');
        }

        /**
         * Copies the data seed to the clipboard.
         */
        function copyDataSeedToClipboard() {
            dataSeedOutput.select();
            document.execCommand('copy');
            showMessageBox('Data seed copied to clipboard!');
        }

        /**
         * Shows the import data menu.
         */
        function showImportDataMenu() {
            settingsContentInitial.classList.add('hidden');
            saveDataSeedMenu.classList.add('hidden');
            importFromClipboardSection.classList.add('hidden');
            settingsContentConfirm.classList.add('hidden');
            confirmImportModal.classList.add('hidden');
            importDataMenu.classList.remove('hidden');
        }

        /**
         * Triggers the file input click for importing from file.
         */
        function triggerImportFromFile() {
            fileInput.click();
        }

        /**
         * Handles file selection and reads the content for import.
         * @param {Event} event - The file input change event.
         */
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const seed = e.target.result;
                processImportedSeed(seed);
            };
            reader.onerror = () => {
                showMessageBox('Error reading file.');
            };
            reader.readAsText(file);
        }

        /**
         * Shows the import from clipboard section.
         */
        function showImportFromClipboardSection() {
            importDataMenu.classList.add('hidden');
            importFromClipboardSection.classList.remove('hidden');
            dataSeedInput.value = ''; // Clear previous input
        }

        /**
         * Processes an imported seed (from clipboard or file).
         * @param {string} seed - The data seed string.
         */
        function processImportedSeed(seed) {
            try {
                const decodedJson = atob(seed); // Base64 decode
                const parsedData = JSON.parse(decodedJson);

                // Basic validation of the imported data structure
                if (typeof parsedData.cash !== 'number' ||
                    !Array.isArray(parsedData.transactions) ||
                    !Array.isArray(parsedData.creditCards)) {
                    throw new Error('Invalid data structure in seed.');
                }

                importedDataToConfirm = parsedData; // Store for confirmation
                importFromClipboardSection.classList.add('hidden'); // Hide clipboard input if it was visible
                importDataMenu.classList.add('hidden'); // Hide import menu
                confirmImportModal.classList.remove('hidden');

            } catch (error) {
                console.error("Error parsing data seed:", error);
                showMessageBox('Invalid data seed. Please check the format.');
            }
        }

        /**
         * Handles the submission of the import data seed from clipboard.
         */
        function handleSubmitClipboardImport() {
            const seed = dataSeedInput.value.trim();
            if (!seed) {
                showMessageBox('Please paste a data seed to import.');
                return;
            }
            processImportedSeed(seed);
        }

        /**
         * Confirms and applies the imported data.
         * This now also saves the imported data to the backend if logged in.
         */
        async function confirmImportAction() {
            if (importedDataToConfirm) {
                cash = importedDataToConfirm.cash;
                transactions = importedDataToConfirm.transactions;
                creditCards = importedDataToConfirm.creditCards;

                updateDashboard();
                renderTransactions();
                renderCreditCards();
                updateOverallUtilization();

                hideSettingsModal(); // Close all settings modals
                showSection('dashboard'); // Go back to dashboard

                if (authToken) {
                    await saveDataToBackend(); // Save imported data to backend
                    showMessageBox('Data imported and saved to server successfully!');
                } else {
                    showMessageBox('Data imported locally. Log in to save to server!');
                }
                importedDataToConfirm = null; // Clear the temporary data
            }
        }

        /**
         * Cancels the import confirmation.
         */
        function cancelImportConfirmation() {
            confirmImportModal.classList.add('hidden');
            importDataMenu.classList.remove('hidden'); // Go back to import options
            importedDataToConfirm = null; // Clear the temporary data
        }

        // --- Backend Integration Functions ---

        /**
         * Handles user registration.
         */
        async function handleRegister(event) {
            event.preventDefault();
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;

            try {
                const response = await fetch(`${API_BASE_URL}/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();
                if (response.ok) {
                    showMessageBox(data.message + " Please log in.");
                    // Switch to login form after successful registration
                    registerCard.classList.add('hidden');
                    loginForm.parentElement.classList.remove('hidden');
                    document.getElementById('loginUsername').value = username; // Pre-fill username
                    document.getElementById('loginPassword').value = '';
                } else {
                    showMessageBox('Registration failed: ' + data.message);
                }
            } catch (error) {
                console.error('Registration error:', error);
                showMessageBox('An error occurred during registration.');
            }
        }

        /**
         * Handles user login.
         */
        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch(`${API_BASE_URL}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();
                if (response.ok) {
                    authToken = data.token;
                    localStorage.setItem('authToken', authToken); // Store token
                    showMessageBox('Login successful!');
                    await loadDataFromBackend(); // Load user data from backend
                    showMainApp(); // Show the main app content
                    startAutoSave(); // Start auto-saving
                } else {
                    showMessageBox('Login failed: ' + data.message);
                }
            } catch (error) {
                console.error('Login error:', error);
                showMessageBox('An error occurred during login.');
            }
        }

        /**
         * Logs out the current user.
         */
        function handleLogout() {
            authToken = null;
            localStorage.removeItem('authToken'); // Clear token
            stopAutoSave(); // Stop auto-saving
            showMessageBox('Logged out successfully!');
            showAuthSection(); // Show login/register forms
            // Clear local data after logout (optional, but good for privacy)
            cash = 0;
            transactions = [];
            creditCards = [];
            updateDashboard();
            renderTransactions();
            renderCreditCards();
            updateOverallUtilization();
        }

        /**
         * Saves current financial data to the backend.
         */
        async function saveDataToBackend() {
            if (!authToken) {
                console.warn("Not authenticated. Data not saved to backend.");
                return;
            }

            const dataToSave = {
                cash: cash,
                transactions: transactions,
                creditCards: creditCards
            };

            try {
                const response = await fetch(`${API_BASE_URL}/save_data`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-access-token': authToken // Include JWT for authentication
                    },
                    body: JSON.stringify(dataToSave)
                });

                const data = await response.json();
                if (response.ok) {
                    console.log('Data saved to backend:', data.message);
                } else {
                    console.error('Failed to save data to backend:', data.message);
                    if (response.status === 401) { // Token expired or invalid
                        showMessageBox('Session expired. Please log in again.');
                        handleLogout(); // Force logout
                    } else {
                        showMessageBox('Failed to save data to server.');
                    }
                }
            } catch (error) {
                console.error('Error saving data to backend:', error);
                showMessageBox('Network error while saving data.');
            }
        }

        /**
         * Loads financial data from the backend.
         */
        async function loadDataFromBackend() {
            if (!authToken) {
                console.warn("Not authenticated. Cannot load data from backend.");
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/load_data`, {
                    method: 'GET',
                    headers: {
                        'x-access-token': authToken // Include JWT for authentication
                    }
                });

                const data = await response.json();
                if (response.ok) {
                    cash = data.cash;
                    transactions = data.transactions;
                    creditCards = data.creditCards;
                    updateDashboard();
                    renderTransactions();
                    renderCreditCards();
                    updateOverallUtilization();
                    showMessageBox('Data loaded from server successfully!');
                } else {
                    console.error('Failed to load data from backend:', data.message);
                    if (response.status === 401) { // Token expired or invalid
                        showMessageBox('Session expired. Please log in again.');
                        handleLogout(); // Force logout
                    } else {
                        showMessageBox('Failed to load data from server.');
                    }
                }
            } catch (error) {
                console.error('Error loading data from backend:', error);
                showMessageBox('Network error while loading data.');
            }
        }

        /**
         * Shows the authentication section (login/register forms).
         */
        function showAuthSection() {
            authSection.classList.remove('hidden');
            mainAppContent.classList.add('hidden');
        }

        /**
         * Shows the main application content.
         */
        function showMainApp() {
            authSection.classList.add('hidden');
            mainAppContent.classList.remove('hidden');
            showSection('dashboard'); // Default to dashboard after login
        }

        /**
         * Starts the auto-save interval.
         */
        function startAutoSave() {
            if (autoSaveIntervalId) {
                clearInterval(autoSaveIntervalId); // Clear any existing interval
            }
            autoSaveIntervalId = setInterval(saveDataToBackend, AUTO_SAVE_INTERVAL);
            console.log(`Auto-save started every ${AUTO_SAVE_INTERVAL / 1000} seconds.`);
        }

        /**
         * Stops the auto-save interval.
         */
        function stopAutoSave() {
            if (autoSaveIntervalId) {
                clearInterval(autoSaveIntervalId);
                autoSaveIntervalId = null;
                console.log('Auto-save stopped.');
            }
        }

        /**
         * Initializes the application by checking authentication status,
         * loading data, and setting up event listeners.
         */
        async function initApp() {
            loadLocalData(); // Only load dark mode preference
            applyTheme(); // Apply saved theme or default

            // Set up authentication form listeners
            loginForm.addEventListener('submit', handleLogin);
            registerForm.addEventListener('submit', handleRegister);
            showRegisterBtn.addEventListener('click', (e) => {
                e.preventDefault();
                registerCard.classList.add('hidden'); // Hide login card
                registerCard.classList.remove('hidden'); // Show register card
                loginForm.parentElement.classList.add('hidden');
            });
            showLoginBtn.addEventListener('click', (e) => {
                e.preventDefault();
                registerCard.classList.add('hidden');
                loginForm.parentElement.classList.remove('hidden');
            });
            logoutBtn.addEventListener('click', handleLogout);


            // Set up navigation
            navDashboard.addEventListener('click', () => showSection('dashboard'));
            navTransactions.addEventListener('click', () => showSection('transactions'));
            navCreditCards.addEventListener('click', () => showSection('creditCards'));

            // Mobile navigation toggle
            mobileNavToggle.addEventListener('click', () => {
                mainNavButtons.classList.toggle('show-mobile-menu');
            });

            // Set up form submissions for financial actions
            transactionForm.addEventListener('submit', handleAddTransaction);
            addCreditCardForm.addEventListener('submit', handleAddCreditCard);
            payCreditCardForm.addEventListener('submit', handlePayCreditCard);
            chargeCreditCardForm.addEventListener('submit', handleChargeCreditCard);

            // Set up modal close buttons
            cancelPayBtn.addEventListener('click', () => payCreditCardModal.classList.remove('show'));
            cancelChargeBtn.addEventListener('click', () => chargeCreditCardModal.classList.remove('show'));

            // Set up Settings modal actions
            settingsBtn.addEventListener('click', showSettingsModal);
            resetDataBtn.addEventListener('click', showResetConfirmation);
            confirmResetBtn.addEventListener('click', clearAllDataAndRefresh);
            cancelResetBtn.addEventListener('click', hideSettingsModal); // Cancel reset also closes modal
            closeSettingsModalBtn.addEventListener('click', hideSettingsModal);

            // Save Data Seed Event Listeners (these now only handle local data seed, not server data)
            saveDataSeedBtn.addEventListener('click', showSaveDataSeedMenu);
            downloadDataSeedBtn.addEventListener('click', downloadDataSeed);
            copyDataSeedToClipboardBtn.addEventListener('click', copyDataSeedToClipboard);
            closeSaveDataSeedMenuBtn.addEventListener('click', showSettingsModal);

            // Import Data Event Listeners (these now import into local state, then offer to save to server)
            importDataBtn.addEventListener('click', showImportDataMenu);
            importFromFileBtn.addEventListener('click', triggerImportFromFile);
            fileInput.addEventListener('change', handleFileImport);
            importFromClipboardBtn.addEventListener('click', showImportFromClipboardSection);
            closeImportDataMenuBtn.addEventListener('click', showSettingsModal);
            cancelClipboardImportBtn.addEventListener('click', showImportDataMenu); // Go back to import options
            submitClipboardImportBtn.addEventListener('click', handleSubmitClipboardImport);
            cancelConfirmImportBtn.addEventListener('click', cancelImportConfirmation);
            confirmImportActionBtn.addEventListener('click', confirmImportAction);

            // Dark mode toggle event listener
            darkModeToggle.addEventListener('change', toggleDarkMode);

            // Check if user is already logged in
            if (authToken) {
                await loadDataFromBackend(); // Attempt to load data with existing token
                showMainApp(); // Show main app if token is valid
                startAutoSave(); // Start auto-saving
            } else {
                showAuthSection(); // Show login/register if no token
            }
        }

        // Run the setup command when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
